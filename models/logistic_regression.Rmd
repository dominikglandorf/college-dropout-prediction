---
title: "Logistic Regression"
author: "Dominik Glandorf"
date: "2023-01-31"
output: pdf_document
---
```{r, include=FALSE}
library(pROC)
if(!require(PRROC)) install.packages('PRROC') # for PR curve
if(!require(caret)) install.packages('caret') # for VarImp
if(!require(car)) install.packages('car') # for vif
```

# Data preparation
## Load data
```{r, warning=FALSE, message=FALSE}
setwd("~/EWS")
source("read_data.R")
data = get_imputed_features()[[1]] %>%
  mutate_if(is.character, as.factor)

data = data %>% select(-major_name_1,  -first_major)
```

# Model estimation
First, split into training and test data
```{r}
sample <- sample(c(TRUE, FALSE), nrow(data), replace=TRUE, prob=c(0.7,0.3))
train <- data[sample, ]
test <- data[!sample, ]
```

```{r}
log.reg.fit = glm(dropout ~ ., train, family = 'binomial')
summary(log.reg.fit)
```
## Check VIF
```{r,fig.height=10}
plot_vif = function (model) {
  vif_values = as.data.frame(vif(model))
  names(vif_values) = c("VIF", "df", "VIF_corrected")
  vif_values$col = row.names(vif_values)
  print(ggplot(vif_values, aes(x=col, y=VIF_corrected)) +
    geom_bar(stat="identity") +
    coord_flip())
}
plot_vif(log.reg.fit)
```
```{r}
log.reg.fit2 = glm(dropout ~ ., train %>% select(-uc_total_score, -num_terms, -first_credits, -cum_avg_credits, -first_credits_major, -first_school), family = 'binomial')
```
```{r}
plot_vif(log.reg.fit2)
```


## Feature Importance
```{r}
log_imp = varImp(log.reg.fit2)
log_imp %>% arrange(-log_imp$Overall)
```
# Model evaluation
```{r, message=FALSE}
dropout_prob = predict(log.reg.fit, test, type = "response") # response outputs the prob instead of log odds

rocobj <- roc(test$dropout, dropout_prob)
auc <- round(auc(test$dropout, dropout_prob),4)
ggroc(rocobj) +
  ggtitle(paste0('ROC Curve ', '(AUC = ', auc, ')')) + 
  geom_abline(intercept = 1, slope = 1, color = "red", linetype = "dashed")
```
```{r}
pr_curve <- pr.curve(scores.class0 = dropout_prob, weights.class0 = as.numeric(test$dropout), curve=T)
#plot(pr_curve, main = "Precision-Recall Curve", xlab = "Recall", ylab = "Precision)
ggplot(as.data.frame(pr_curve$curve), aes(x=V1, y=V2)) +
  geom_line() +
  ylim(0, 1) +
  geom_hline(yintercept=mean(test$dropout)) +
  labs(title=paste0("PR-Curve (AUC: ", round(pr_curve$auc.davis.goadrich, 2), ")"),
       x="Recall",
       y="Precision")
```
