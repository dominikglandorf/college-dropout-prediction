---
title: "Logistic Regression"
author: "Dominik Glandorf"
date: "2023-01-31"
output: pdf_document
---
```{r, include=FALSE}
if(!require(caret)) install.packages('caret') # for VarImp
if(!require(car)) install.packages('car') # for vif
```

# Data preparation
## Load data
```{r, warning=FALSE, message=FALSE}
setwd("~/EWS")
source('models/evaluation.R')
source("read_data.R")
data = get_imputed_features()[[1]] %>%
  mutate_if(is.character, as.factor)

data = data%>% select(-major_name_1,  -first_major, -first_school)
```

# Model estimation
First, split into training and test data
```{r}
sample <- sample(c(TRUE, FALSE), nrow(data), replace=TRUE, prob=c(0.7,0.3))
train <- data[sample, ]
test <- data[!sample, ]
```

```{r}
log.reg.fit = glm(dropout ~ ., train, family = 'binomial')
summary(log.reg.fit)
```
## Check VIF
```{r,fig.height=10}
plot_vif = function (model) {
  vif_values = as.data.frame(vif(model))
  names(vif_values) = c("VIF", "df", "VIF_corrected")
  vif_values$col = row.names(vif_values)
  print(ggplot(vif_values, aes(x=col, y=VIF_corrected)) +
    geom_bar(stat="identity") +
    coord_flip())
}
plot_vif(log.reg.fit)
```
```{r}
log.reg.fit2 = glm(dropout ~ ., train %>% select(-uc_total_score, -num_terms, -first_credits, -cum_avg_credits), family = 'binomial')
plot_vif(log.reg.fit2)
```


## Feature Importance
```{r}
log_imp = varImp(log.reg.fit2)
log_imp %>% arrange(-log_imp$Overall)
```
# Model evaluation
Scores of the model:
```{r}
predicted_scores = predict(log.reg.fit2, test, type = "response") # response outputs the prob instead of log odds
true_labels = test$dropout
```
Find best threshold-based metrics:
```{r}
acc = accuracy_by_threshold(predicted_scores, true_labels)
plot_metric_by_threshold(acc$accuracies, metric_label="Accuracy")

Fscores = Fbetascore_by_threshold(predicted_scores, true_labels)
plot_metric_by_threshold(Fscores$Fscores, metric_label="F2 score")
```
Plot ROC and PR Curve and calculate Areas under Curve
```{r}
plot_ROC(predicted_scores, true_labels)
plot_PR(predicted_scores, true_labels)
```

