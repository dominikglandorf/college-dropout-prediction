---
title: "Majors, courses and credits"
author: "Dominik Glandorf"
date: '2022-08-19'
output: pdf_document
---

```{r setup, include=FALSE}
if(!require(gridExtra)) install.packages('gridExtra')
source('read_data.R')
```

```{r prepare data}
students = get_student_sub()
bg = get_student_background_data(ids = students$mellon_id)
terms = get_term_data(ids = students$mellon_id)
terms = merge(terms, students[,c('mellon_id','admitdate','dropout')], by="mellon_id")
# enumerate terms order by their date
terms_ordered = terms[order(terms$term_code),c('mellon_id','term_code')]
terms_ordered$term_num = ave(terms_ordered$mellon_id, terms_ordered$mellon_id, FUN=seq_along)
terms = merge(terms, terms_ordered, by=c("mellon_id","term_code"))
```
```{r}
courses = get_course_data(ids = students$mellon_id)
```


```{r, echo=FALSE, results="hide"}
# there is some additional major information in the background data
table(bg_sub$grad_major_1)
```
```{r, echo=FALSE, results="hide"}
colSums(is.na(bg_sub[,c("grad_major_1","grad_major_2","grad_major_3")]))
```
```{r, echo=FALSE, results="hide"}
terms$major_code_1
table(terms[,c('major_name_1','major_code_1')])
```

```{r}
# department code, units in eigenem dept vs fremden dept
#aggregate(credits mellon_id, terms)
```
# Availability of units information
```{r}
ggplot(terms, aes(x=admitdate, fill=!is.na(current_units_attempted_total))) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Current units attempted total available",
       x = "Admission",
       y = "", fill="Available")
```
```{r}
ggplot(terms, aes(x=admitdate, fill=!is.na(current_units_completed_total))) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Current units completed total available",
       x = "Admission",
       y = "", fill="Available")
```
```{r}
length(unique(terms[!is.na(terms$current_units_attempted_total),'mellon_id']))
```
For 11612 distinct students we have information about current_units_attempted_total

```{r}
unique(terms[!is.na(terms$current_units_attempted_total),'mellon_id'])[1:100]
```
```{r}
terms[terms$mellon_id=='163019',86:121]
```
```{r}
ggplot(terms, aes(x=admitdate, fill=!is.na(cumulative_units_completed_total))) +
  geom_bar() +
  theme_minimal() +
  labs(title = "Cumulative units completed total available",
       x = "Admission",
       y = "", fill="Available")
```

```{r}
units_summary = is.na(terms[,names(terms)[86:121]])
colSums(units_summary)[order(-colSums(units_summary))]
```
```{r}
sum(is.na(terms$cumulative_term_enroll))
```

```{r}
avg_credits = aggregate(terms$current_units_completed_total, by=list("mellon_id"=terms$mellon_id), FUN=mean)
avg_credits_admission = aggregate(terms$current_units_completed_total, by=list("admitdate"=terms$admitdate), FUN=mean)
avg_credits_major = aggregate(terms$current_units_completed_total, by=list("major"=terms$major_name_1), FUN=mean)
avg_credits_term = aggregate(terms$current_units_completed_total, by=list("term_num"=terms$term_num), FUN=mean)
avg_credits_major_term = aggregate(terms$current_units_completed_total, by=list("major"=terms$major_name_1, "term_num"=terms$term_num), FUN=mean)
```
```{r}
ggplot(avg_credits_admission, aes(x=admitdate, y=x)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  labs(title = "Mean of current units completed total",
       x = "Admission",
       y = "Credit")
```
Current units does not seem to considerable vary between cohorts.

```{r}
ggplot(avg_credits_term, aes(x=term_num, y=x)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  labs(title = "Mean of current units completed total by term number",
       x = "Term number",
       y = "Credit")
```

```{r, fig.width=14}
fill=c(rep(c("1","2"), 53),"1")
ggplot(avg_credits_major, aes(x=major, y=x, fill=fill)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  labs(title = "Mean of current units completed total per major",
       x = "Major",
       y = "Credits", fill="")+
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  scale_fill_manual(values = c("1"="#353436", "2"="#1b98e0"))+
  theme(legend.position = "none")
```
```{r, fig.height=50}
ggplot(avg_credits_major_term, aes(x=term_num, y=x)) +
  geom_bar(stat="identity") +
  theme_minimal() +
  labs(title = "Mean of current units completed total per term",
       x = "Term",
       y = "Credits", fill="")+
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme(legend.position = "none") +
  facet_wrap(vars(major), ncol = 8)
```

# Can we get more information from the courses table?
```{r}
names(courses)
```
Let's see how much missing data we have here.
```{r}
mean(is.na(courses$units_attempted))
```
Only 7 percent missing data is promising. Let's aggregate the units per student/term.
```{r}
units_attempted=aggregate(courses$units_attempted, by=list(mellon_id=courses$mellon_id, term=courses$term_code), FUN=sum, na.action = na.omit)
```
```{r}
mean(is.na(terms$current_units_attempted_total)) - mean(is.na(units_attempted$x))
```
Now we have 82 percent less data missing. Let's see if there is a temporal pattern.
```{r}
term_missing=aggregate(is.na(units_attempted$x), by=list(term=units_attempted$term), FUN=mean)
```
```{r}
term_missing[order(-term_missing$x),]
```
The information is missing for more recent terms. Maybe there were studies that did not attempt units there?
```{r}
units_attempted[units_attempted$term==201903,]
```
```{r}
courses[courses$mellon_id==162784,c('term_desc','course_dept_code_and_num','units_attempted','units_completed')]
```
Why are some courses listed twice?
```{r}
courses[courses$mellon_id==162784,]
```
It looks like there are different 

# Do people with more than 1 major select a different number of units?
# Features: current units completed, relative to term number, major 1, people with same number of majors

